<!DOCTYPE html>
<html>

<head>
	<title>Weather Complete</title>
	<meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div id='main-container'>
		<div id='weather-container'>
		</div> 
	</div>
	<div id='side-container'>
		<div>
			<input id='search-input' placeholder='search for a city'></input>
			<button id='search-button' onclick="search()">search</button>
		</div>
		<ul id='search-results-list'></ul>
	</div>
</body>

<script>
		// USE YOUR OWN API KEY
		const apiKey = "2f8efe8461a5200a50d483564799e02c";

        // variable that stores the city that is chosen
		let city;
        // variable that stores the weather and forecast for the city
		let weather;
        // the variable that stores the air quality index for the city
		let aqi;

		// function that accepts that a number N and returns the name of the day and the date N days from now as a string
		function formatDate(daysFromNow = 0) {
			let output = ''
			var date = new Date();
			date.setDate(date.getDate() + daysFromNow);
			output += date.toLocaleString('en-US', { weekday: 'long' }).toUpperCase()
			output += ' ' + date.getDate()
			return output
		}

		// function that uses OpenWeatherMap's geocoding API to find locations
		function search() {
			// takes the value from the search input
			let searchInput = document.querySelector("#search-input").value;
			if (searchInput) {
				// creates the API call with the value from the search input as a query
				let apiCall = `https://api.openweathermap.org/geo/1.0/direct?q=${searchInput},,US&limit=5&appid=${apiKey}`;
				// calls the API
				fetch(apiCall)
					.then((response) => 
						// after recieving a response, take the response from the server and convert it to JSON 
						response.json()
					)
					.then((data) => {
						// after recieving the converted JSON data, pass the JSON to the renderSearchResults() function
						renderSearchResults(data)
					});
			}
		}

		// function that renders the search results as a unordered list
		function renderSearchResults(searchResults) {
				// selects the unordered list element search-results-list
				const ul = document.querySelector('#search-results-list')
				// shows the unordered list if was hidden previously
				ul.classList.remove("hidden");
				// clears out any list items from the previous search
				ul.innerHTML = ''
				// loops through each search result and creates and attaches a list item for the unordered list
				searchResults.forEach((searchResult, index) => {
					// creates a new unordered list element
					const li = document.createElement('li')
					// sets the list item's class as search-result
					li.setAttribute('class', 'search-result')
					// sets the text inside the list item as the name and state of the city 
					const fullName = searchResult.name + ', ' + searchResult.state
					li.innerHTML = fullName
					// if the list item of a city is clicked, call the selectCity() function
					li.addEventListener('click', () => selectCity(fullName, searchResult.name, searchResult.state, searchResult.lat, searchResult.lon))
					// attaches the list item elements to search-results-list
					ul.appendChild(li)
			})	
		}

		// function that is called whenever a city has been selected
		// HINT: think about what should be rendering on the screen whenever a city is selected and what information is needed to make that happen 
		function selectCity(fullName, name, state, lat, lon) {
			// hides the search-results-list since it is not needed right now
			document.querySelector('#search-results-list').className = 'hidden'
			// sets the global city variable
			document.querySelector("#search-input").value = ''
			city = {
				fullName: fullName,
				name: name,
				state: state,
				lat: lat,
				lon: lon
			}
			//printing the city object to the console
			console.log(city);
            // BEGIN CODING HERE
			getWeatherData(lat, lon, name, state);
			getAQI(lat, lon);
		}

		async function getWeatherData(lat, lon, cityName, state) {

			let weatherApiCall = `http://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&exclude=minutely,hourly,alerts&units=metric&appid=${apiKey}`;
			let weatherResponse = await fetch(weatherApiCall);
			let weatherData = await weatherResponse.json();
			
			console.log('Weather data: ', weatherData);
			displayCurrentWeather(weatherData.current, cityName, state);
			displayForecase(data.daily);
		}

		function displayCurrentWeather(current, cityName, state) {
            document.getElementById('cityName').textContent = `${cityName}, ${state}`;
            document.getElementById('temperature').textContent = `${Math.round(current.temp)}°C`;
            document.getElementById('weatherDescription').textContent = current.weather[0].description;
            document.getElementById('feelsLike').textContent = `${Math.round(current.feels_like)}°C`;
            document.getElementById('humidity').textContent = `${current.humidity}%`;
            document.getElementById('windSpeed').textContent = `${current.wind_speed} m/s`;
            document.getElementById('pressure').textContent = `${current.pressure} hPa`;
            
            const iconCode = current.weather[0].icon;
            document.getElementById('weatherIcon').src = `https://openweathermap.org/img/wn/${iconCode}@4x.png`;
            document.getElementById('weatherIcon').alt = current.weather[0].description;
            
            currentWeather.classList.add('active');
        }

		function displayForecast(daily) {
            const forecastCards = document.getElementById('forecastCards');
            forecastCards.innerHTML = '';
            
            // Display next 5 days (skip today, index 0)
            for (let i = 1; i <= 5; i++) {
                const day = daily[i];
                const date = new Date(day.dt * 1000);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                
                const card = document.createElement('div');
                card.className = 'forecast-card';
                
                const iconCode = day.weather[0].icon;
                
                card.innerHTML = `
                    <div class="forecast-date">${dayName}</div>
                    <img class="forecast-icon" src="https://openweathermap.org/img/wn/${iconCode}@2x.png" alt="${day.weather[0].description}">
                    <div class="forecast-temp">${Math.round(day.temp.day)}°C</div>
                    <div class="forecast-description">${day.weather[0].description}</div>
                    <div class="forecast-minmax">H: ${Math.round(day.temp.max)}° L: ${Math.round(day.temp.min)}°</div>
                `;
                
                forecastCards.appendChild(card);
            }
		}

		async function getAQI(lat, lon) {
			let aqiApiCall = `http://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`;
			let aqiResponse = await fetch(aqiApiCall);
			let aqiData = await aqiResponse.json();

			console.log('Air Quality data: ', aqiData);
			if (data.list && data.list.length > 0) {
                const aqi = data.list[0].main.aqi;
                displayAirQuality(aqi);
            }		
		}

		function displayAirQuality(aqi) {
            const aqiValue = document.getElementById('aqiValue');
            const aqiDescription = document.getElementById('aqiDescription');
            
            const aqiLevels = {
                1: { text: 'Good', class: 'aqi-good', desc: 'Air quality is satisfactory' },
                2: { text: 'Fair', class: 'aqi-fair', desc: 'Air quality is acceptable' },
                3: { text: 'Moderate', class: 'aqi-moderate', desc: 'Sensitive individuals should limit outdoor activity' },
                4: { text: 'Poor', class: 'aqi-poor', desc: 'Everyone may experience health effects' },
                5: { text: 'Very Poor', class: 'aqi-very-poor', desc: 'Health alert: everyone may experience serious effects' }
            };
            
            const level = aqiLevels[aqi] || aqiLevels[1];
            
            aqiValue.textContent = level.text;
            aqiValue.className = `aqi-value ${level.class}`;
            aqiDescription.textContent = ` - ${level.desc}`;
        }
		
	</script>
</html>